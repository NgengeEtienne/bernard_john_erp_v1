{% extends "base2.html" %}

{% block content %}
<div class="mx-4"><a href="{% url 'bakery:production' %}" class="btn btn-primary my-2">Back to Prodcution</a></div>
<div class=" w-100 mb-0">
    
    <div class="container-fluid" style="background-color: #F5F5F5; min-height: 100vh; padding: 20px;">
        <!-- Header -->
        <div class="container card mb-4">
            <div class="card-header bg- text-white px-4">
                <div class="fw-500">OUTPUT PRODUCTION RECIPE</div>
            </div>
    
            <!-- Forms Section -->
            <div class="card-body">
                <form id="category-form" class="mx-auto" style="width: 50%;">
                    <div class="form-group">
                        <label for="production_id_select" class="form-label mb-0">Choose a Production:</label>
                        <select id="production_id_select" name="production_id" class="form-control">
                            <option value="" disabled selected>-- Select a Production ID --</option>
                            {% for production_id in production_ids %}
                                <option value="{{ production_id }}">{{ production_id }}</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Start typing to select Production</small>
                    </div>
                </form>
            </div>
            
            
        </div>
    
        <!-- Raw Materials Section -->
    <!-- <div id="display"> -->
                <!-- Display Section for Production Details -->
        <div id="display" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-header bg-secondary text-white px-4">
                    <h5 class="mb-0 lead text-white">Production Details</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Product</th>
                                    <th>Mixture Number</th>
                                    <th>Quantity</th>
                                    <th>Price (CFA)</th>
                                    <th>Amount (CFA)</th>
                                </tr>
                            </thead>
                            <tbody id="raw-materials-body">
                                <!-- AJAX will populate this section -->
                            </tbody>
                            <tfoot id="tfoot">
                                <!-- Total Output Value will be added here by JavaScript -->
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    <!-- </div> -->
     <div class="container-fluid" style="background-color: #F5F5F5"  id="display2" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header bg-info text-white px-4 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 lead text-white">Production Detail Results</h5>
                <h5 class="mb-0 text-white">Total MIXTURE: <span id="total-mixture" class="large-font font-weight-bold">300,000</span> g</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>weight/boule</th>
                                <th>Output/boule</th>
                                <th>Estimated Output</th>
                                <th>RM needed</th>
                                <th>Deduct FROM TOTAL</th>
                            </tr>
                        </thead>
                        <tbody id="output-calculations-body">
                            <!-- AJAX will populate this section -->
                        </tbody>
                        <tfoot id="output-calculations-footer">
                            <!-- Total Output Value will be added here by JavaScript -->
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
     </div>
        
            <!-- Two-column Section -->
                    <!-- Raw Material Tables Section -->
            <div id="raw-materials-tables" class="row mt-4">
                <!-- Dynamic tables will be inserted here -->
            </div>
        </div>
</div>
    
        
{% load static %}
 <link rel="stylesheet" href="{% static '' %}app-assets/custom/selectize.bootstrap3.css">
<script src="{% static '' %}app-assets/custom/jquery-3.6.0.min.js"></script>
<script src="{% static 'app-assets/custom/selectize.min.js' %}"></script>
<!-- Include Selectize.js CSS -->
<script>
   
    // });
</script>


<script>
    var $j = jQuery.noConflict();
    $j(document).ready(function() {
    //   $j('#production_id_selec').selectize({
    //     create: false,                   // Disable creating new items
    //     sortField: 'text',
    //     labelField: 'name',
    
    //     allowEmptyOption: true,          // Allows empty first option to act as placeholder
    //     onInitialize: function() {
    //       // Add form-control class to the generated input field
    //       this.$control.addClass('form-control');
    //     }
    //   });
      var $select = $j('select[name$="production_i"]').selectize({  
            create: false,
            sortField: {
                field: 'text',
                direction: 'asc'
            }
        });
        $j('.selectize-input').addClass('form-control');
        var selectizeControl = $select[0].selectize;  
        var options = selectizeControl.options;  
        for (var key in options) {  // Loop through each option and store it in the productNames array #}
            if (options.hasOwnProperty(key)) {
                productNames.push({ value: key, text: options[key].text });
            }
        }
    });

    
</script>


<script>
    $(document).ready(function () {
        $('#display').hide();
        $('#display2').hide();
        function renderProductionTable(materials, totals) {
            const tbody = $('#raw-materials-body').empty();
            materials.forEach(item => {
                tbody.append(`
                    <tr>
                        <td>${item.output_category}</td>
                        <td>${item.product}</td>
                        <td>${item.mixture_number}</td>
                        <td>${parseFloat(item.qty).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
                        <td>${parseFloat(item.product_price).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} CFA</td>
                        <td>${parseFloat(item.value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} CFA</td>
                    </tr>
                `);
            });
    
            // Add the total row
            $('#tfoot').html(`
                <tr>
                    <th colspan="5" class=" font-weight-bold">Total Output Value:</th>
                    <th colspan="5" class="font-weight-bold">${parseFloat(totals.total_value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} CFA</th>
                </tr>
            `);
        }
        
        function renderRawMaterialTables(rawMaterialDetails) {
            const tablesContainer = $('#raw-materials-tables').empty();

            if (!Array.isArray(rawMaterialDetails)) {
                console.error("Expected an array for raw materials, but got:", rawMaterialDetails);
                return; // Exit the function if the data is not in the expected format
            }

            rawMaterialDetails.forEach((recipe_details, index) => {
                // console.log("recipe_details:", recipe_details.recipe_details.materials.length);
                const tableHtml = `
                
                    <div class="col-lg-6">
                        <div class="card w-100">
                            <div class="card-header bg-secondary text-white px-4">
                               <div class="fw-500">
                                    Estimated Production Raw Material for <span class="large-font">${recipe_details.product}</span>
                                </div>

                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-striped table-sm mb-0">
                                        <thead class="text-xs font-monospace">
                                            <tr>
                                                <td class="px-1 py-2 border-bottom-0 text-muted">Raw Material</td>
                                                <td class="px-1 py-2 border-bottom-0 text-muted">Raw Required/Unit Output (grams)</td>
                                                <td class="px-1 py-2 border-bottom-0 text-muted">Total RM Required (grams)</td>
                                                <td class="px-1 py-2 border-bottom-0 text-muted">Price/Gram</td>
                                                <td class="px-1 py-2 border-bottom-0 text-muted">Total Cost</td>
                                            </tr>
                                        </thead>
                                        <tbody id="est-raw-materials-body${index + 1}">
                                            ${recipe_details.recipe_details.materials.length ? '' : '<tr><td colspan="5" class="text-center text-muted p-4">No Raw Materials Available!</td></tr>'}
                                        </tbody>
                                        <tfoot id="est-tfoot${index + 1}" class="font-weight-bold">

                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                tablesContainer.append(tableHtml);

                // Populate the raw material table
                const tbody = $(`#est-raw-materials-body${index + 1}`);
                // console.log(recipe_details);
                recipe_detailses=recipe_details.recipe_details.materials
                recipe_detailses.forEach(material => {
                    tbody.append(`
                        <tr>
                            <td>${material.ingredient}</td>
                            <td>${parseFloat(material.quantity_grams).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} grams</td>
                            <td>${parseFloat(material.required_grams).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} grams</td>
                            <td>${parseFloat(material.price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} CFA</td>
                            <td>${parseFloat(material.total_cost).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} CFA</td>
                        </tr>
                    `);
                });

                const tfoot = $(`#est-tfoot${index + 1}`);
                console.log(tfoot);
                const material = recipe_details.recipe_details.totals;
                    tfoot.append(`
                        <tr>
                            <td class="font-weight-bold ">Total</td>
                            <td class="font-weight-bold ">${parseFloat(material.total_quantity).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} grams</td>
                            <td class="font-weight-bold ">${parseFloat(material.total_required_grams).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} grams</td>
                            <td class="font-weight-bold ">${parseFloat(material.total_price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} CFA</td>
                            <td class="font-weight-bold ">${parseFloat(material.total_cost).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} CFA</td>
                        </tr>
                    `);
                
            });
        }
        function weight(productionData,totals) {
    const outputCalculationsBody = document.getElementById('output-calculations-body');
    const outputCalculationsFooter = document.getElementById('output-calculations-footer');
    // console.log(productionData)
    const rows = productionData.map(item => ({
        product: item.product,
        weightBoule: item.weight_per_boule,
        outputBoule: item.output_per_boul,
        estimatedOutput: item.product_unit_weight,
        rmNeeded: `${item.percentage}%`,
        deductFromTotal: `${parseFloat(item.price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} CFA`
    }));

    totals=totals
            
    // Append header row to body
    const headerRow = document.createElement('tr');
    headerRow.innerHTML = `
        <th colspan="3" class="font-weight-bold ">Total RM Needed:</th>
        <td class="font-weight-bold ">${parseFloat(totals.total_raw_material_grams).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</td>
        <th  class="font-weight-bold ">Total Raw Material Cost:</th>
        <td class="font-weight-bold ">${parseFloat(totals.total_raw_material_price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} CFA</td>
    `;
    outputCalculationsBody.appendChild(headerRow);

    // Populate table with data
    rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.product}</td>
            <td>${row.weightBoule}</td>
            <td>${row.outputBoule}</td>
            <td>${row.estimatedOutput}</td>
            <td>${row.rmNeeded}</td>
            <td>${row.deductFromTotal}</td>
        `;
        outputCalculationsBody.appendChild(tr);
    });

    // Append totals row to footer
    outputCalculationsFooter.innerHTML = `
        <tr>
            <th colspan="3" class="font-weight-bold">Return to Pot:</th>
            <td class="font-weight-bold">${parseFloat(totals.total_raw_material_remaining).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} kg</td>
            <th class="font-weight-bold">${parseFloat(totals.total_raw_material_remaining_percentage).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%</th>
            <td class="font-weight-bold">${parseFloat(totals.total_raw_material_remaining_price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} CFA</td>

        </tr>
    `;
}

    
        $('#production_id_select').on('change', function () {
            const production_id = $(this).val();
            
            if (production_id) {
                $.ajax({
                    type: 'GET',
                    url: "{% url 'bakery:get_production_recipe' %}",
                    data: { production_id },
                    success: function (data) {
                        // console.log(data);
                        $('#display').show();
                        $('#display2').show();
                        renderProductionTable(data.production, data.totals);
                        renderRawMaterialTables(data.production); // Pass the recipe details to render
                        weight(data.weight,data.totals);
                    },
                    error: function () {
                        alert('Failed to load production details.');
                    }
                });
            } else {
                $('#display').hide();
                $('#display2').hide();
                $('#raw-materials-body').empty();
                $('#tfoot').empty();
                $('#raw-materials-tables').empty();
            }
        });
    
        $('#output,#recipe').on('keypress', function (e) {
            if (e.which === 13) {
                e.preventDefault();
                $('#recipe').trigger('change');  // Reuse change event
            }
        });
    });
    </script>
    
    
    
{% endblock %}
